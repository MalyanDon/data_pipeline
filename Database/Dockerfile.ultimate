# ===================================================
# ULTIMATE DOCKERFILE - FORCE CLEAN BUILD
# ===================================================

FROM node:18-alpine

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apk add --no-cache python3 py3-pip make g++ postgresql-client

# Debug: Show what we have initially
RUN echo "=== INITIAL STATE ===" && pwd && ls -la

# Copy package files
COPY package*.json ./

# Debug: Show package files
RUN echo "=== PACKAGE FILES ===" && ls -la package*.json

# Install dependencies
RUN npm install --production

# Debug: Show after npm install
RUN echo "=== AFTER NPM INSTALL ===" && ls -la

# CRITICAL: Copy the main file EXPLICITLY and verify
COPY working-upload-system.js ./

# Debug: Verify main file was copied
RUN echo "=== MAIN FILE VERIFICATION ===" && \
    if [ -f "working-upload-system.js" ]; then \
        echo "âœ… working-upload-system.js EXISTS!" && \
        echo "ğŸ“ Size: $(wc -c < working-upload-system.js) bytes" && \
        echo "ğŸ“„ First 3 lines:" && head -3 working-upload-system.js && \
        echo "ğŸ” File permissions:" && ls -la working-upload-system.js; \
    else \
        echo "âŒ working-upload-system.js MISSING!" && \
        echo "ğŸ“ Available files:" && ls -la && \
        echo "ğŸ“ Available .js files:" && ls -la *.js 2>/dev/null || echo "No .js files found"; \
    fi

# Copy all other files
COPY . .

# Debug: Final state
RUN echo "=== FINAL STATE ===" && \
    echo "ğŸ“ All files in /app:" && ls -la && \
    echo "" && \
    echo "ğŸ“ JavaScript files:" && ls -la *.js && \
    echo "" && \
    echo "ğŸ“¦ Package.json start script:" && \
    if [ -f "package.json" ]; then \
        grep -A 2 -B 2 "start" package.json; \
    else \
        echo "âŒ package.json not found!"; \
    fi

# Create upload directory
RUN mkdir -p temp_uploads

# Expose port
EXPOSE 3000

# Start command with explicit verification
CMD ["sh", "-c", "echo 'ğŸš€ Starting application...' && echo 'ğŸ“ Current directory:' && pwd && echo 'ğŸ“ Files:' && ls -la && echo 'ğŸ“„ Main file:' && ls -la working-upload-system.js && echo 'ğŸ”§ Starting npm start...' && npm start"] 